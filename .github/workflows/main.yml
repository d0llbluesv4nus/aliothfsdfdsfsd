name: Port ROM for Poco F3 (Split Archive Fix)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'Ссылка на STOCK Fastboot ROM (Poco F3)'
        required: true
      port_url:
        description: 'Ссылка на PORT Fastboot ROM (Donor)'
        required: true
      rom_name:
        description: 'Имя для zip архива'
        required: false
        default: 'Alioth_Hybrid_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Очистка места
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      # 2. Установка инструментов
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 python3 git p7zip-full android-sdk-libsparse-utils build-essential zlib1g-dev liblz4-dev liblzma-dev autoconf libtool pkg-config uuid-dev file
          
          # lpunpack
          aria2c --allow-overwrite=true --check-certificate=false -o lpunpack "https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpunpack"
          chmod +x lpunpack
          sudo mv lpunpack /usr/local/bin/
          
          # EROFS Utils
          git clone https://github.com/erofs/erofs-utils.git
          cd erofs-utils
          ./autogen.sh
          ./configure --enable-lz4
          make
          sudo make install
          cd ..
          rm -rf erofs-utils

      - name: Prepare Dirs
        run: |
          mkdir -p workspace/final_rom/images
          mkdir -p workspace/assets_to_patch
          mkdir -p workspace/temp

      # 3. СТОК
      - name: Harvest Stock Files
        run: |
          cd workspace
          echo ">>> Downloading Stock..."
          aria2c -x4 -s4 "${{ inputs.stock_url }}" -o stock.tgz
          
          echo ">>> Extracting Stock..."
          7z x stock.tgz -o./temp -y
          if ls temp/*.tar 1> /dev/null 2>&1; then 7z x temp/*.tar -o./temp -y; fi
          
          # Забираем файлы
          find temp -type f -name "boot.img" -exec mv {} final_rom/images/ \;
          find temp -type f -name "dtbo.img" -exec mv {} final_rom/images/ \;
          find temp -type f -name "vbmeta.img" -exec mv {} final_rom/images/ \;
          
          SUPER_IMG=$(find temp -type f -name "super.img" | head -n 1)
          if [ -f "$SUPER_IMG" ]; then
             simg2img "$SUPER_IMG" super.raw
             lpunpack super.raw .
             find . -name "product*.img" -exec mv {} product.img \;
             find . -name "vendor*.img" -exec mv {} final_rom/images/vendor.img \;
          else
             find temp -type f -name "product.img" -exec mv {} product.img \;
             find temp -type f -name "vendor.img" -exec mv {} final_rom/images/vendor.img \;
          fi
          
          # Распаковка Product для конфигов
          if [ -f product.img ]; then
             TYPE=$(file -b product.img)
             if [[ "$TYPE" == *"EROFS"* ]]; then fsck.erofs --extract=stock_extracted product.img; else 7z x product.img -ostock_extracted; fi
             
             XML=$(find stock_extracted -name "alioth.xml" | head -n 1)
             if [ -f "$XML" ]; then cp "$XML" assets_to_patch/; fi
             
             OVL=$(find stock_extracted -name "AospFrameworkResOverlay.apk" | head -n 1)
             if [ -f "$OVL" ]; then cp "$OVL" assets_to_patch/; fi
          fi
          
          echo ">>> DELETING STOCK..."
          rm -rf stock.tgz temp super.raw product.img stock_extracted

      # 4. ПОРТ
      - name: Process Port & Patch
        run: |
          cd workspace
          echo ">>> Downloading Port..."
          aria2c -x4 -s4 "${{ inputs.port_url }}" -o port.tgz
          
          echo ">>> Extracting Port..."
          7z x port.tgz -o./temp -y
          if ls temp/*.tar 1> /dev/null 2>&1; then 7z x temp/*.tar -o./temp -y; fi
          
          SUPER_IMG=$(find temp -type f -name "super.img" | head -n 1)
          if [ -f "$SUPER_IMG" ]; then
             simg2img "$SUPER_IMG" super.raw
             lpunpack super.raw .
             find . -name "system*.img" -not -name "*ext*" -exec mv {} final_rom/images/system.img \;
             find . -name "system_ext*.img" -exec mv {} final_rom/images/system_ext.img \;
             find . -name "mi_ext*.img" -exec mv {} final_rom/images/mi_ext.img \; || true
             find . -name "product*.img" -exec mv {} product.img \;
             rm super.raw
          else
             find temp -type f -name "system.img" -exec mv {} final_rom/images/ \;
             find temp -type f -name "system_ext.img" -exec mv {} final_rom/images/ \;
             find temp -type f -name "mi_ext.img" -exec mv {} final_rom/images/ \;
             find temp -type f -name "product.img" -exec mv {} product.img \;
          fi
          
          rm -rf port.tgz temp
          
          # Патчинг
          if [ -f product.img ]; then
             TYPE=$(file -b product.img)
             if [[ "$TYPE" == *"EROFS"* ]]; then fsck.erofs --extract=port_extracted product.img; else 7z x product.img -oport_extracted; fi
             rm product.img
             
             if [ -f assets_to_patch/alioth.xml ]; then
                TARGET_DIR="port_extracted/etc/device_features"
                mkdir -p "$TARGET_DIR"
                cp assets_to_patch/alioth.xml "$TARGET_DIR/"
                find "$TARGET_DIR" -type f -name "*.xml" ! -name "alioth.xml" -delete
             fi
             
             if [ -f assets_to_patch/AospFrameworkResOverlay.apk ]; then
                cp assets_to_patch/AospFrameworkResOverlay.apk port_extracted/overlay/ || true
             fi
             
             PROP=$(find port_extracted -name "build.prop" | head -n 1)
             if [ -f "$PROP" ]; then
                echo >> "$PROP"
                echo "ro.product.product.name=alioth" >> "$PROP"
                echo "ro.product.product.device=alioth" >> "$PROP"
                echo "ro.product.product.model=M2012K11AC" >> "$PROP"
             fi
             
             mkfs.erofs -zlz4hc,9 -T 1230768000 --mount-point /product final_rom/images/product.img port_extracted
             rm -rf port_extracted assets_to_patch
          fi

      - name: Pack Final ZIP (SPLIT)
        id: pack
        run: |
          cd workspace/final_rom
          
          cat <<EOF > Flash_ROM.bat
          @echo off
          echo Flashing Port ROM...
          fastboot flash boot images/boot.img
          fastboot flash dtbo images/dtbo.img
          fastboot flash vendor images/vendor.img
          fastboot flash system images/system.img
          fastboot flash system_ext images/system_ext.img
          fastboot flash product images/product.img
          if exist images\mi_ext.img fastboot flash mi_ext images/mi_ext.img
          echo Done. Rebooting...
          fastboot reboot
          pause
          EOF
          
          ZIP_NAME="${{ inputs.rom_name }}.zip"
          
          # --- ГЛАВНОЕ ИЗМЕНЕНИЕ ---
          # -v2000m: Разбивает архив на тома по 2000 МБ (GitHub лимит 2ГБ)
          7z a -tzip -mx1 -v2000m "$ZIP_NAME" .
          
          echo "RELEASE_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Alioth Port ${{ env.RELEASE_TAG }}
          body: |
            Automatic Port for Poco F3
            Base: ${{ inputs.port_url }}
            
            **INSTRUCTIONS:**
            Because the file is >2GB, it is split into parts.
            1. Download ALL parts (.001, .002, etc).
            2. Open the first file (.001) with 7-Zip/WinRAR.
            3. Extract.
          # Используем wildcard (*) чтобы загрузить все части архива (.zip.001, .zip.002...)
          files: workspace/final_rom/${{ inputs.rom_name }}.zip.*
