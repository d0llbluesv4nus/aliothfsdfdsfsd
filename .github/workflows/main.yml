name: Poco F3 Port (OFox Fail-Safe)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'STOCK Fastboot ROM (alioth)'
        required: true
      port_url:
        description: 'PORT Fastboot ROM (donor)'
        required: true
      rom_name:
        description: 'ZIP name'
        default: 'Alioth_Port_Release'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1. Очистка места
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      # 2. Установка инструментов
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full git file unzip \
            android-sdk-libsparse-utils erofs-utils \
            build-essential liblz4-dev liblzma-dev uuid-dev e2fsprogs

          # lpunpack
          wget -q https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpunpack -O lpunpack
          chmod +x lpunpack && sudo mv lpunpack /usr/local/bin/

          # make_ext4fs (TWRPDtGen Mirror)
          if wget -q https://github.com/twrpdtgen/binaries/raw/master/linux/x86/make_ext4fs -O make_ext4fs; then
             chmod +x make_ext4fs
             sudo mv make_ext4fs /usr/local/bin/
          else
             echo "Using mke2fs fallback."
          fi

          # Magiskboot
          wget -q https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          unzip -q Magisk-v27.0.apk -d magisk
          cp magisk/lib/x86_64/libmagiskboot.so magiskboot
          chmod +x magiskboot && sudo mv magiskboot /usr/local/bin/
          rm -rf magisk Magisk-v27.0.apk

      - name: Prepare workspace
        run: mkdir -p workspace/{stock,port,final/images,assets,checks,repack_source}

      # 3. Обработка STOCK
      - name: Process STOCK
        run: |
          WS="$GITHUB_WORKSPACE/workspace"
          FINAL="$WS/final/images"
          REPACK_SRC="$WS/repack_source"
          ASSETS="$WS/assets"
          
          cd "$WS/stock"
          echo ">>> Downloading Stock..."
          aria2c -x4 -s4 "${{ inputs.stock_url }}" -o stock.tgz
          tar -xf stock.tgz && rm stock.tgz

          IMG_DIR=$(find . -type d -name "images" | head -n1)
          if [ -z "$IMG_DIR" ]; then IMG_DIR=$(find . -name "boot.img" -printf "%h\n" | head -n1); fi
          cd "$IMG_DIR"

          SUPER=$(find . -name "super.img" | head -n1)
          if [ -f "$SUPER" ]; then
             simg2img "$SUPER" super.raw
             lpunpack super.raw .
             rm super.raw
          fi

          # Бэкап стокового ядра (ВАЖНО для Fail-Safe)
          cp boot.img "$FINAL/boot_stock.img"
          cp dtbo.img "$FINAL/"
          cp vbmeta.img "$FINAL/"
          
          find . -name "vendor*.img" -printf "%s %p\n" | sort -n | tail -1 | awk '{print $2}' | xargs -I {} mv {} "$REPACK_SRC/vendor.img"
          find . -name "odm*.img" -printf "%s %p\n" | sort -n | tail -1 | awk '{print $2}' | xargs -I {} mv {} "$REPACK_SRC/odm.img" || true
          
          PRODUCT=$(ls -S product*.img | head -1)
          if fsck.erofs --extract=product_fs "$PRODUCT"; then
             echo "STOCK_FS=erofs" >> $GITHUB_ENV
          else
             echo "STOCK_FS=ext4" >> $GITHUB_ENV
             7z x "$PRODUCT" -oproduct_fs
          fi

          find product_fs -name "fstab.*" -exec cp {} "$ASSETS/" \; || true
          
          echo ">>> Saving alioth.xml..."
          XML=$(find product_fs -name "alioth.xml" | head -n 1)
          if [ -f "$XML" ]; then cp "$XML" "$ASSETS/"; fi

          rm -rf product_fs

      # 4. Обработка PORT
      - name: Process PORT & Repack
        run: |
          WS="$GITHUB_WORKSPACE/workspace"
          REPACK_SRC="$WS/repack_source"
          FINAL="$WS/final/images"
          ASSETS="$WS/assets"
          
          cd "$WS/port"
          echo ">>> Downloading Port..."
          aria2c -x4 -s4 "${{ inputs.port_url }}" -o port.tgz
          tar -xf port.tgz && rm port.tgz

          IMG_DIR=$(find . -type d -name "images" | head -n1)
          if [ -z "$IMG_DIR" ]; then IMG_DIR=$(find . -name "system.img" -printf "%h\n" | head -n1); fi
          if [ -z "$IMG_DIR" ]; then IMG_DIR=$(find . -name "super.img" -printf "%h\n" | head -n1); fi
          cd "$IMG_DIR"
          
          SUPER=$(find . -name "super.img" | head -n1)
          if [ -f "$SUPER" ]; then
             simg2img "$SUPER" super.raw
             lpunpack super.raw .
             rm super.raw
          fi
          
          find . -name "system*.img" -not -name "*ext*" -printf "%s %p\n" | sort -n | tail -1 | awk '{print $2}' | xargs -I {} mv {} "$REPACK_SRC/system.img"
          find . -name "system_ext*.img" -printf "%s %p\n" | sort -n | tail -1 | awk '{print $2}' | xargs -I {} mv {} "$REPACK_SRC/system_ext.img"
          find . -name "product*.img" -printf "%s %p\n" | sort -n | tail -1 | awk '{print $2}' | xargs -I {} mv {} "$REPACK_SRC/product.img"
          find . -name "mi_ext*.img" -printf "%s %p\n" | sort -n | tail -1 | awk '{print $2}' | xargs -I {} mv {} "$REPACK_SRC/mi_ext.img" || true

          cd "$REPACK_SRC"
          
          repack() {
            NAME=$1
            if [ -f "${NAME}.img" ]; then
               echo ">>> Optimizing $NAME..."
               rm -rf extracted && mkdir extracted
               
               if ! fsck.erofs --extract=extracted "${NAME}.img" 2>/dev/null; then
                  7z x "${NAME}.img" -oextracted > /dev/null
               fi
               rm "${NAME}.img"

               if [ -f "$ASSETS/fstab.qcom" ]; then
                  find extracted -name "fstab.*" -delete
                  cp "$ASSETS"/fstab.* extracted/etc/ 2>/dev/null || true
                  mkdir -p extracted/vendor/etc 2>/dev/null || true
                  cp "$ASSETS"/fstab.* extracted/vendor/etc/ 2>/dev/null || true
               fi
               
               if [ "$NAME" == "product" ]; then
                   
                   # Inject alioth.xml
                   if [ -f "$ASSETS/alioth.xml" ]; then
                      TARGET_DIR="extracted/etc/device_features"
                      mkdir -p "$TARGET_DIR"
                      cp "$ASSETS/alioth.xml" "$TARGET_DIR/"
                      find "$TARGET_DIR" -type f -name "*.xml" ! -name "alioth.xml" -delete
                   fi

                   # Patch build.prop
                   PROP=$(find extracted -name "build.prop" | head -n 1)
                   if [ -f "$PROP" ]; then
                      echo >> "$PROP"
                      echo "# Alioth Port Params" >> "$PROP"
                      echo "ro.product.product.name=alioth" >> "$PROP"
                      echo "ro.product.product.device=alioth" >> "$PROP"
                      echo "ro.product.product.model=M2012K11AC" >> "$PROP"
                      echo "ro.product.board=alioth" >> "$PROP"
                   fi

                   # Debloating
                   echo "   -> Debloating..."
                   sudo rm -rf extracted/data-app/*
                   sudo rm -rf extracted/app/AnalyticsCore
                   sudo rm -rf extracted/app/MSA
                   sudo rm -rf extracted/app/MiVideoGlobal
                   sudo rm -rf extracted/app/Facebook*
                   sudo rm -rf extracted/priv-app/Facebook*
               fi

               OUTPUT_IMG="$FINAL/${NAME}.img"
               
               if [ "${{ env.STOCK_FS }}" = "erofs" ]; then
                  mkfs.erofs -zlz4hc -C16384 "$OUTPUT_IMG" extracted
               else
                  SIZE_MB=$(du -sm extracted | awk '{print $1+100}')
                  if command -v make_ext4fs >/dev/null; then
                      make_ext4fs -s -L $NAME -l ${SIZE_MB}M -a $NAME "$OUTPUT_IMG" extracted/
                  else
                      truncate -s ${SIZE_MB}M raw.img
                      mke2fs -t ext4 -b 4096 -L $NAME -M /$NAME -O ^has_journal -d extracted raw.img
                      img2simg raw.img "$OUTPUT_IMG"
                      rm raw.img
                  fi
               fi
               rm -rf extracted
            fi
          }

          repack vendor
          repack odm
          repack system
          repack system_ext
          repack product
          repack mi_ext

      # 5. Установка OrangeFox (FAIL-SAFE)
      - name: Inject OrangeFox Recovery
        run: |
          cd "$GITHUB_WORKSPACE/workspace/final/images"
          
          echo ">>> Downloading OrangeFox..."
          # Используем aria2c, так как он лучше обрабатывает редиректы
          # Добавляем "|| true", чтобы ошибка скачивания НЕ ОСТАНАВЛИВАЛА скрипт
          aria2c -o ofox.zip "https://downloads.sourceforge.net/project/orangefox/alioth/OrangeFox-R11.1_6_A12-Stable-alioth.zip" || true
          
          if [ -f ofox.zip ]; then
             unzip -q ofox.zip recovery.img
             rm ofox.zip
          fi
          
          if [ -f recovery.img ]; then
             echo ">>> ✅ OrangeFox downloaded! Using as boot.img..."
             mv recovery.img boot.img
             
             echo ">>> Patching OrangeFox (Permissive)..."
             magiskboot unpack boot.img
             if [ -f header ]; then
                if ! grep -q "androidboot.selinux=permissive" header; then
                    sed -i 's/$/ androidboot.selinux=permissive/' header
                fi
             fi
             magiskboot repack boot.img
             mv new-boot.img boot.img
             rm -f header kernel ramdisk.cpio dtb
          else
             echo ">>> ⚠️ OrangeFox download failed! Reverting to Stock Boot..."
             # Если OFox не скачался, берем родное ядро
             mv boot_stock.img boot.img
             
             # Но его тоже надо пропатчить на Permissive, чтобы порт запустился!
             echo ">>> Patching Stock Boot (Permissive)..."
             magiskboot unpack boot.img
             if [ -f header ]; then
                if ! grep -q "androidboot.selinux=permissive" header; then
                    sed -i 's/$/ androidboot.selinux=permissive/' header
                fi
             fi
             magiskboot repack boot.img
             mv new-boot.img boot.img
             rm -f header kernel ramdisk.cpio dtb
          fi
          
          # Удаляем бэкап, он больше не нужен
          rm -f boot_stock.img

      # 6. Упаковка
      - name: Pack ZIP
        run: |
          cd "$GITHUB_WORKSPACE/workspace/final"
          
          wget -q https://dl.google.com/android/repository/platform-tools-latest-windows.zip -O tools.zip
          unzip -q tools.zip
          cp -r platform-tools/* .
          rm -rf platform-tools tools.zip

          cat <<EOF > flash_all.bat
          @echo off
          echo Starting Flash Process...
          
          if not exist fastboot.exe (
              echo ERROR: fastboot.exe not found!
              pause
              exit
          )

          echo STEP 1: Flashing Boot...
          fastboot flash boot images/boot.img
          echo Flashing DTBO/VBMETA...
          fastboot flash dtbo images/dtbo.img
          fastboot --disable-verity --disable-verification flash vbmeta images/vbmeta.img

          echo.
          echo STEP 2: Rebooting to FASTBOOTD...
          fastboot reboot fastboot
          echo Waiting 15 seconds for FastbootD...
          timeout /t 15 /nobreak > nul

          echo.
          echo STEP 3: Flashing System...
          echo flashing vendor...
          fastboot flash vendor images/vendor.img
          if exist images\odm.img (
              echo flashing odm...
              fastboot flash odm images/odm.img
          )
          echo flashing system...
          fastboot flash system images/system.img
          echo flashing system_ext...
          fastboot flash system_ext images/system_ext.img
          echo flashing product...
          fastboot flash product images/product.img
          if exist images\mi_ext.img (
              echo flashing mi_ext...
              fastboot flash mi_ext images/mi_ext.img
          )

          echo.
          echo STEP 4: Wiping Data...
          fastboot -w

          echo.
          echo Done! Rebooting...
          fastboot reboot
          pause
          EOF

          ZIP="${{ inputs.rom_name }}.zip"
          sudo 7z a -tzip -mx1 -v2000m "$ZIP" .
          sudo chown $USER:$USER "$ZIP"*
          
          echo "TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Alioth Port ${{ env.TAG }}
          files: workspace/final/${{ inputs.rom_name }}.zip.*
