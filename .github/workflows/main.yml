name: Poco F3 ROM Port (BOOT-SAFE v3)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'STOCK Fastboot ROM (alioth)'
        required: true
      port_url:
        description: 'PORT Fastboot ROM (donor)'
        required: true
      rom_name:
        description: 'ZIP name'
        default: 'Alioth_Port_SAFE'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1. Агрессивная очистка места (Критически важна для больших прошивок)
      - name: Free Disk Space (Aggressive)
        run: |
          echo "Свободное место до очистки:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Свободное место после очистки:"
          df -h

      # 2. Установка необходимых инструментов
      - name: Install tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full git file unzip \
            android-sdk-libsparse-utils build-essential \
            liblz4-dev liblzma-dev autoconf libtool pkg-config uuid-dev e2fsprogs

          # Утилита lpunpack
          aria2c -o lpunpack https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpunpack
          chmod +x lpunpack && sudo mv lpunpack /usr/local/bin/

          # Утилиты EROFS
          git clone https://github.com/erofs/erofs-utils.git
          cd erofs-utils
          ./autogen.sh && ./configure && make
          sudo make install
          cd .. && rm -rf erofs-utils

          # Magiskboot для патча ядра
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          unzip Magisk-v27.0.apk -d magisk
          cp magisk/lib/x86_64/libmagiskboot.so magiskboot
          chmod +x magiskboot && sudo mv magiskboot /usr/local/bin/
          rm -rf magisk Magisk-v27.0.apk

      - name: Prepare workspace
        run: mkdir -p workspace/{stock,port,final/images,assets,checks}

      # 3. Обработка STOCK (Критическое исправление распаковки и пути)
      - name: Process STOCK (kernel + fstab source)
        run: |
          set -e
          cd workspace/stock
          aria2c "${{ inputs.stock_url }}" -o stock.tgz
          
          # 3.1. ИСПРАВЛЕНИЕ: Используем tar для полной распаковки .tgz
          echo "Распаковка STOCK с помощью tar..."
          tar -xvf stock.tgz
          rm stock.tgz # Освобождаем место сразу

          # 3.2. ИСПРАВЛЕНИЕ: Проверяем наличие вложенной папки (например, alioth_global_images_...)
          # и переходим в нее, чтобы найти .img файлы.
          IMG_SUBDIR=$(find . -maxdepth 1 -type d -name "*images*" | head -n1)
          if [ ! -z "$IMG_SUBDIR" ] && [ "$IMG_SUBDIR" != "." ]; then
            cd "$IMG_SUBDIR"
            echo "Переход во вложенную папку: $IMG_SUBDIR"
          fi

          # 3.3. Теперь все файлы должны быть доступны в текущей директории
          SUPER=$(find . -maxdepth 1 -name super.img | head -n1)
          if [ -z "$SUPER" ]; then 
              echo "❌ super.img не найден после распаковки. Проверьте структуру архива."
              exit 1 
          fi

          simg2img "$SUPER" super.raw
          lpunpack super.raw .
          rm super.raw "$SUPER" || true 

          # boot, dtbo, vbmeta должны быть скопированы из текущей папки, где лежат .img файлы
          cp boot.img dtbo.img vbmeta.img ../../final/images/ || true

          PRODUCT=$(ls product*.img | sort -n | tail -1)
          if file "$PRODUCT" | grep -q EROFS; then
            echo "STOCK_FS=erofs" >> $GITHUB_ENV
            dump.erofs -x product_fs "$PRODUCT"
          else
            echo "STOCK_FS=ext4" >> $GITHUB_ENV
            7z x "$PRODUCT" -oproduct_fs
          fi

          # Копирование fstab (путь к assets из вложенной папки)
          find product_fs -name "fstab.*" -exec cp {} ../../assets/ \; || true
          grep -R "ro.build.version.release" product_fs | head -n1 > ../../checks/stock_android.txt || true
          rm -rf product_fs

      # 4. Обработка PORT (с аналогичным исправлением пути)
      - name: Process PORT (system only)
        run: |
          set -e
          cd workspace/port
          aria2c "${{ inputs.port_url }}" -o port.tgz
          
          # ИСПРАВЛЕНИЕ: Используем tar для полной распаковки .tgz
          echo "Распаковка PORT с помощью tar..."
          tar -xvf port.tgz
          rm port.tgz # Освобождаем место

          # ИСПРАВЛЕНИЕ: Проверяем наличие вложенной папки и переходим в нее
          IMG_SUBDIR=$(find . -maxdepth 1 -type d -name "*images*" | head -n1)
          if [ ! -z "$IMG_SUBDIR" ] && [ "$IMG_SUBDIR" != "." ]; then
            cd "$IMG_SUBDIR"
            echo "Переход во вложенную папку: $IMG_SUBDIR"
          fi

          SUPER=$(find . -maxdepth 1 -name super.img | head -n1)
          if [ -z "$SUPER" ]; then 
              echo "❌ super.img не найден в PORT. Проверьте структуру архива."
              exit 1 
          fi
          
          simg2img "$SUPER" super.raw
          lpunpack super.raw .
          rm super.raw "$SUPER" || true

          PRODUCT=$(ls product*.img | sort -n | tail -1)
          if file "$PRODUCT" | grep -q EROFS; then
            dump.erofs -x product_fs "$PRODUCT"
          else
            7z x "$PRODUCT" -oproduct_fs
          fi
          grep -R "ro.build.version.release" product_fs | head -n1 > ../../checks/port_android.txt || true
          rm -rf product_fs

          # Проверка версий Android
          diff ../../checks/stock_android.txt ../../checks/port_android.txt || {
            echo "❌ Android version mismatch – abort"
            exit 1
          }

          repack() {
            NAME=$1
            # Поиск в текущей папке (.img)
            IMG=$(ls ${NAME}*.img 2>/dev/null | sort -n | tail -1 || true)
            [ -z "$IMG" ] && return

            rm -rf extracted && mkdir extracted
            if file "$IMG" | grep -q EROFS; then
              dump.erofs -x extracted "$IMG"
            else
              7z x "$IMG" -oextracted
            fi

            # fstab fix: путь к assets изменился на ../../assets/
            find extracted -name "fstab.*" -delete
            cp ../../assets/fstab.* extracted/vendor/etc/ 2>/dev/null || cp ../../assets/fstab.* extracted/etc/ 2>/dev/null || true

            SIZE=$(du -sm extracted | awk '{print $1+300}')M
            if [ "${{ env.STOCK_FS }}" = "erofs" ]; then
              mkfs.erofs -zlz4 ../../final/images/${NAME}.img extracted
            else
              # Используем make_ext4fs.
              if ! command -v make_ext4fs &> /dev/null; then
                  echo "make_ext4fs не найдена. Пропуск создания $NAME."
                  return
              fi
              make_ext4fs -s -l $SIZE -a $NAME ../../final/images/${NAME}.img extracted
            fi

            rm -rf extracted "$IMG"
          }

          for p in system system_ext product vendor odm mi_ext; do
            repack $p
          done

      # 5. Патч boot
      - name: Patch boot (alioth-safe)
        run: |
          set -e
          cd workspace/final/images
          magiskboot unpack boot.img
          [ -f kernel ] && magiskboot hexpatch kernel \
            73656C696E75783D656E666F7263696E67 \
            73656C696E75783D7065726D697373697665
          magiskboot repack boot.img
          mv new-boot.img boot.img

      # 6. Упаковка и релиз
      - name: Pack ZIP
        run: |
          set -e
          cd workspace/final
          cat <<EOF > flash_all.bat
          @echo off
          fastboot flash boot images/boot.img
          fastboot flash dtbo images/dtbo.img
          fastboot flash vendor images/vendor.img
          fastboot flash system images/system.img
          fastboot flash system_ext images/system_ext.img
          fastboot flash product images/product.img
          fastboot reboot
          pause
          EOF

          ZIP="${{ inputs.rom_name }}.zip"
          7z a -tzip -mx1 "$ZIP" .
          echo "TAG=v$(date +'%Y.%m.%d-%H%M')-${GITHUB_RUN_ID}" >> $GITHUB_ENV

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Alioth Port SAFE ${{ env.TAG }}
          files: workspace/final/${{ inputs.rom_name }}.zip
