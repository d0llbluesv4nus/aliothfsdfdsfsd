name: Alioth Universal Port (A14-A16 + super)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        required: true
      port_url:
        required: true
      rom_name:
        default: Alioth_Universal_A14+

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: jlumbroso/free-disk-space@main

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y aria2 p7zip-full unzip \
            android-sdk-libsparse-utils erofs-utils \
            e2fsprogs build-essential

          wget -q https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpunpack -O /usr/local/bin/lpunpack
          wget -q https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpmake -O /usr/local/bin/lpmake
          chmod +x /usr/local/bin/lp*

      - name: Prepare workspace
        run: mkdir -p ws/{stock,port,src,out}

      # ===== STOCK =====
      - name: Extract STOCK
        run: |
          cd ws/stock
          aria2c ${{ inputs.stock_url }} -o stock.tgz
          tar -xf stock.tgz
          simg2img images/super.img super.raw
          lpunpack super.raw .
          cp boot.img dtbo.img vbmeta.img ../out/
          mv vendor*.img odm*.img ../src/
          mv product*.img ../src/stock_product.img

      # ===== PORT =====
      - name: Extract PORT
        run: |
          cd ws/port
          aria2c ${{ inputs.port_url }} -o port.tgz
          tar -xf port.tgz
          simg2img images/super.img super.raw
          lpunpack super.raw .
          mv system*.img system_ext*.img product*.img ../src/

      # ===== REPACK =====
      - name: Repack images
        run: |
          set -e
          cd ws/src

          extract() {
            rm -rf out && mkdir out
            fsck.erofs --extract=out "$1" || 7z x "$1" -oout
          }

          extract product*.img
          PROP=$(find out -name build.prop | head -n1)
          ANDROID=$(grep ro.build.version.release $PROP | cut -d= -f2)
          PATCH=$(grep ro.build.version.security_patch $PROP | cut -d= -f2)
          rm -rf out

          clean_oem() {
            rm -rf out/overlay out/product/overlay
            rm -rf out/priv-app/*Color* out/priv-app/*Oppo* out/priv-app/*Meizu*
            rm -rf out/etc/init/*.rc
          }

          repack() {
            NAME=$1
            extract "$2"
            clean_oem
            PROP=$(find out -name build.prop | head -n1)
            sed -i "s/ro.build.version.release=.*/ro.build.version.release=$ANDROID/" $PROP
            sed -i "s/ro.build.version.security_patch=.*/ro.build.version.security_patch=$PATCH/" $PROP
            [ "$NAME" = "product" ] && cat >> $PROP <<EOF
ro.product.device=alioth
ro.product.model=M2012K11AC
ro.product.name=alioth
EOF
            mkfs.erofs -zlz4hc ../out/$NAME.img out
            rm -rf out
          }

          repack system system*.img
          [ -f system_ext*.img ] && repack system_ext system_ext*.img
          repack product product*.img

          cp vendor*.img odm*.img ../out/

      # ===== SUPER =====
      - name: Build super.img
        run: |
          cd ws/out
          lpmake \
            --metadata-size 65536 \
            --super-name super \
            --device super:9126805504 \
            --group main:9126805504 \
            --partition system:readonly:$(stat -c%s system.img):main \
            --image system=system.img \
            --partition system_ext:readonly:$(stat -c%s system_ext.img):main \
            --image system_ext=system_ext.img \
            --partition product:readonly:$(stat -c%s product.img):main \
            --image product=product.img \
            --partition vendor:readonly:$(stat -c%s vendor.img):main \
            --image vendor=vendor.img \
            --partition odm:readonly:$(stat -c%s odm.img):main \
            --image odm=odm.img \
            --output super.img

      # ===== ZIP =====
      - name: Pack ZIP
        run: |
          cd ws
          7z a ${{ inputs.rom_name }}.zip out

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: v$(date +%Y%m%d)
          files: ws/${{ inputs.rom_name }}.zip
          
