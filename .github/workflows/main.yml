name: Port ROM for Poco F3 (Imjtool Method)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'Ссылка на STOCK Fastboot ROM (Poco F3)'
        required: true
      port_url:
        description: 'Ссылка на PORT Fastboot ROM (Donor)'
        required: true
      rom_name:
        description: 'Имя для zip архива'
        required: false
        default: 'Alioth_Hybrid_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Очистка места (30GB+)
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      # 2. Установка инструментов (IMJTOOL вместо lpunpack)
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 python3 git p7zip-full erofs-utils android-sdk-libsparse-utils build-essential
          
          # Компилируем imjtool (этот репозиторий прост и надежен)
          echo "Building imjtool..."
          git clone https://github.com/Androides/imjtool.git
          cd imjtool
          # Компилируем простой C-файл
          gcc -o imjtool imjtool.c
          sudo mv imjtool /usr/local/bin/
          cd ..
          rm -rf imjtool
          
          # Проверяем
          if command -v imjtool >/dev/null; then echo "imjtool installed!"; else exit 1; fi

      - name: Prepare Workspace
        run: mkdir -p workspace/images workspace/temp_extract

      # 3. СТОК
      - name: Process Stock ROM
        run: |
          cd workspace
          ARIA_ARGS="-x4 -s4 --check-certificate=false --max-tries=5 --retry-wait=10"
          
          echo ">>> Downloading Stock..."
          aria2c $ARIA_ARGS "${{ inputs.stock_url }}" -o stock.tgz
          
          echo ">>> Extracting Stock..."
          7z x stock.tgz -o./temp_extract -y
          if ls temp_extract/*.tar 1> /dev/null 2>&1; then 7z x temp_extract/*.tar -o./temp_extract -y; fi
          
          # Забираем простые файлы
          find temp_extract -type f -name "boot.img" -exec mv {} images/ \;
          find temp_extract -type f -name "dtbo.img" -exec mv {} images/ \;
          find temp_extract -type f -name "vbmeta.img" -exec mv {} images/ \;
          
          # Ищем super.img
          SUPER_IMG=$(find temp_extract -type f -name "super.img" | head -n 1)
          
          if [ -f "$SUPER_IMG" ]; then
             echo ">>> Super partition detected. Unpacking with imjtool..."
             # Конвертируем в raw (imjtool иногда требует этого)
             simg2img "$SUPER_IMG" super.raw
             
             # imjtool распаковывает ВСЕ разделы в текущую папку
             mkdir super_extracted
             cd super_extracted
             imjtool ../super.raw extract
             
             # Забираем Product и Vendor (ищем по маске, т.к. может быть product_a.img)
             echo "Moving partitions..."
             find . -name "product*.img" -exec mv {} ../images/stock_product.img \;
             find . -name "vendor*.img" -exec mv {} ../images/vendor.img \;
             cd ..
             rm -rf super_extracted super.raw
          else
             echo ">>> No super.img found, searching individual images..."
             find temp_extract -type f -name "vendor.img" -exec mv {} images/ \;
             find temp_extract -type f -name "product.img" -exec mv {} images/stock_product.img \;
          fi

          echo ">>> Cleaning up Stock..."
          rm stock.tgz
          rm -rf temp_extract/*
          
          if [ ! -f images/stock_product.img ]; then echo "CRITICAL: Stock Product not found!"; exit 1; fi

      # 4. ПОРТ
      - name: Process Port ROM
        run: |
          cd workspace
          ARIA_ARGS="-x4 -s4 --check-certificate=false --max-tries=5 --retry-wait=10"
          
          echo ">>> Downloading Port..."
          aria2c $ARIA_ARGS "${{ inputs.port_url }}" -o port.tgz
          
          echo ">>> Extracting Port..."
          7z x port.tgz -o./temp_extract -y
          if ls temp_extract/*.tar 1> /dev/null 2>&1; then 7z x temp_extract/*.tar -o./temp_extract -y; fi
          
          SUPER_IMG=$(find temp_extract -type f -name "super.img" | head -n 1)
          
          if [ -f "$SUPER_IMG" ]; then
             echo ">>> Unpacking Port Super..."
             simg2img "$SUPER_IMG" super.raw
             
             mkdir super_extracted
             cd super_extracted
             imjtool ../super.raw extract
             
             echo "Moving partitions..."
             find . -name "system*.img" -not -name "*ext*" -exec mv {} ../images/system.img \;
             find . -name "system_ext*.img" -exec mv {} ../images/system_ext.img \;
             find . -name "product*.img" -exec mv {} ../images/port_product.img \;
             find . -name "mi_ext*.img" -exec mv {} ../images/mi_ext.img \; || true
             
             cd ..
             rm -rf super_extracted super.raw
          else
             echo ">>> No super.img found..."
             find temp_extract -type f -name "system.img" -exec mv {} images/ \;
             find temp_extract -type f -name "system_ext.img" -exec mv {} images/ \;
             find temp_extract -type f -name "product.img" -exec mv {} images/port_product.img \;
             find temp_extract -type f -name "mi_ext.img" -exec mv {} images/ \;
          fi

          echo ">>> Cleaning up Port..."
          rm port.tgz
          rm -rf temp_extract

      # 5. СБОРКА ОБРАЗА
      - name: Patch Product Partition
        run: |
          cd workspace/images
          
          if [ ! -f "stock_product.img" ] || [ ! -f "port_product.img" ]; then
             echo "ERROR: Images missing!"
             ls -lh
             exit 1
          fi

          echo ">>> Unpacking EROFS..."
          extract.erofs -i stock_product.img -x -o stock_extracted
          extract.erofs -i port_product.img -x -o port_extracted

          echo ">>> Copying Features..."
          TARGET_DIR="port_extracted/etc/device_features"
          SOURCE_FILE="stock_extracted/etc/device_features/alioth.xml"
          if [ -f "$SOURCE_FILE" ]; then
             mkdir -p "$TARGET_DIR"
             cp "$SOURCE_FILE" "$TARGET_DIR/"
             find "$TARGET_DIR" -type f -name "*.xml" ! -name "alioth.xml" -delete
          fi

          echo ">>> Swapping Overlays..."
          OVERLAY_SRC="stock_extracted/overlay/AospFrameworkResOverlay.apk"
          OVERLAY_DST="port_extracted/overlay/AospFrameworkResOverlay.apk"
          if [ -f "$OVERLAY_SRC" ]; then cp "$OVERLAY_SRC" "$OVERLAY_DST"; fi

          echo ">>> Modifying build.prop..."
          echo >> "port_extracted/build.prop"
          echo "ro.product.product.name=alioth" >> "port_extracted/build.prop"
          echo "ro.product.product.device=alioth" >> "port_extracted/build.prop"
          echo "ro.product.product.model=M2012K11AC" >> "port_extracted/build.prop"
          
          echo ">>> Repacking Product..."
          rm port_product.img stock_product.img
          mkfs.erofs -zlz4hc,9 -T 1230768000 --mount-point /product product.img port_extracted
          
          rm -rf stock_extracted port_extracted

      - name: Pack Final ZIP
        id: pack
        run: |
          cd workspace
          mkdir -p final_rom
          mv images/*.img final_rom/
          
          cd final_rom
          cat <<EOF > Flash_ROM.bat
          @echo off
          echo Flashing Port ROM...
          fastboot flash boot boot.img
          fastboot flash dtbo dtbo.img
          fastboot flash vendor vendor.img
          fastboot flash system system.img
          fastboot flash system_ext system_ext.img
          fastboot flash product product.img
          if exist mi_ext.img fastboot flash mi_ext mi_ext.img
          echo Done. Rebooting...
          fastboot reboot
          pause
          EOF
          
          ZIP_NAME="${{ inputs.rom_name }}.zip"
          7z a -tzip -mx1 "$ZIP_NAME" .
          
          echo "ZIP_PATH=$(pwd)/$ZIP_NAME" >> $GITHUB_ENV
          echo "RELEASE_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Alioth Port ${{ env.RELEASE_TAG }}
          body: |
            Automatic Port for Poco F3
            Base: ${{ inputs.port_url }}
          files: ${{ env.ZIP_PATH }}
