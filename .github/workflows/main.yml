name: Poco F3 ROM Port (BOOT-SAFE v3)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'STOCK Fastboot ROM (alioth)'
        required: true
      port_url:
        description: 'PORT Fastboot ROM (donor)'
        required: true
      rom_name:
        description: 'ZIP name'
        default: 'Alioth_Port_SAFE'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: jlumbroso/free-disk-space@main
        with:
          android: true
          docker-images: true

      # ================= TOOLS =================
      - name: Install tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full git file unzip \
            android-sdk-libsparse-utils build-essential \
            liblz4-dev liblzma-dev autoconf libtool pkg-config uuid-dev

          aria2c -o lpunpack https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpunpack
          chmod +x lpunpack && sudo mv lpunpack /usr/local/bin/

          git clone https://github.com/erofs/erofs-utils.git
          cd erofs-utils
          ./autogen.sh && ./configure && make
          sudo make install
          cd .. && rm -rf erofs-utils

          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          unzip Magisk-v27.0.apk -d magisk
          cp magisk/lib/x86_64/libmagiskboot.so magiskboot
          chmod +x magiskboot && sudo mv magiskboot /usr/local/bin/
          rm -rf magisk Magisk-v27.0.apk

      # ================= PREP =================
      - name: Prepare workspace
        run: |
          set -e
          mkdir -p workspace/{stock,port,final/images,assets,checks}

      # ================= STOCK =================
      - name: Process STOCK (kernel + fstab source)
        run: |
          set -e
          cd workspace/stock
          aria2c "${{ inputs.stock_url }}" -o stock.tgz
          7z x stock.tgz -y

          SUPER=$(find . -name super.img | head -n1)
          simg2img "$SUPER" super.raw
          lpunpack super.raw .

          # Kernel & DT*
          cp boot.img dtbo.img vbmeta.img ../final/images/

          PRODUCT=$(ls product*.img | sort -n | tail -1)
          if file "$PRODUCT" | grep -q EROFS; then
            echo "STOCK_FS=erofs" >> $GITHUB_ENV
            dump.erofs -x product_fs "$PRODUCT"
          else
            echo "STOCK_FS=ext4" >> $GITHUB_ENV
            7z x "$PRODUCT" -oproduct_fs
          fi

          # fstab + android version
          find product_fs vendor_fs -name "fstab.*" -exec cp {} ../assets/ \; || true
          grep -R "ro.build.version.release" product_fs | head -n1 > ../checks/stock_android.txt || true

      # ================= PORT =================
      - name: Process PORT (system only)
        run: |
          set -e
          cd workspace/port
          aria2c "${{ inputs.port_url }}" -o port.tgz
          7z x port.tgz -y

          SUPER=$(find . -name super.img | head -n1)
          simg2img "$SUPER" super.raw
          lpunpack super.raw .

          # Android version check
          PRODUCT=$(ls product*.img | sort -n | tail -1)
          if file "$PRODUCT" | grep -q EROFS; then
            dump.erofs -x product_fs "$PRODUCT"
          else
            7z x "$PRODUCT" -oproduct_fs
          fi
          grep -R "ro.build.version.release" product_fs | head -n1 > ../checks/port_android.txt || true

          diff ../checks/stock_android.txt ../checks/port_android.txt || {
            echo "❌ Android version mismatch – abort"
            exit 1
          }

          repack() {
            NAME=$1
            IMG=$(ls ${NAME}*.img 2>/dev/null | sort -n | tail -1 || true)
            [ -z "$IMG" ] && return

            rm -rf extracted && mkdir extracted
            if file "$IMG" | grep -q EROFS; then
              dump.erofs -x extracted "$IMG"
            else
              7z x "$IMG" -oextracted
            fi

            # fstab fix
            find extracted -name "fstab.*" -delete
            cp ../assets/fstab.* extracted/ 2>/dev/null || true

            SIZE=$(du -sm extracted | awk '{print $1+300}')M
            if [ "${{ env.STOCK_FS }}" = "erofs" ]; then
              mkfs.erofs -zlz4 ../final/images/${NAME}.img extracted
            else
              make_ext4fs -s -l $SIZE -a $NAME ../final/images/${NAME}.img extracted
            fi

            rm -rf extracted "$IMG"
          }

          for p in system system_ext product vendor odm mi_ext; do
            repack $p
          done

      # ================= BOOT =================
      - name: Patch boot (alioth-safe)
        run: |
          set -e
          cd workspace/final/images
          magiskboot unpack boot.img
          [ -f kernel ] && magiskboot hexpatch kernel \
            73656C696E75783D656E666F7263696E67 \
            73656C696E75783D7065726D697373697665
          magiskboot repack boot.img
          mv new-boot.img boot.img

      # ================= ZIP =================
      - name: Pack ZIP
        run: |
          set -e
          cd workspace/final
          cat <<EOF > flash.bat
          fastboot flash boot images/boot.img
          fastboot flash dtbo images/dtbo.img
          fastboot flash vendor images/vendor.img
          if exist images\\odm.img fastboot flash odm images\\odm.img
          fastboot flash system images/system.img
          fastboot flash system_ext images/system_ext.img
          fastboot flash product images/product.img
          fastboot reboot
          pause
          EOF

          ZIP="${{ inputs.rom_name }}.zip"
          7z a -tzip -mx1 "$ZIP" .
          echo "TAG=v$(date +'%Y.%m.%d-%H%M')-${GITHUB_RUN_ID}" >> $GITHUB_ENV

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Alioth Port SAFE ${{ env.TAG }}
          files: workspace/final/${{ inputs.rom_name }}.zip
