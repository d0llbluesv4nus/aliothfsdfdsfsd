name: Alioth Universal OEM Port

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: "Stock fastboot ROM (alioth)"
        required: true
      port_url:
        description: "Donor / OEM fastboot ROM"
        required: true
      rom_name:
        description: "Output ZIP name"
        default: "Alioth_Universal_Port"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      # ===============================
      # AGGRESSIVE DISK CLEANUP
      # ===============================
      - name: Free disk space (aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/share/swift
          sudo apt clean
          df -h

      - name: Check free space
        run: |
          AVAIL=$(df --output=avail -BG / | tail -1 | tr -dc '0-9')
          echo "Free space: ${AVAIL}G"
          if [ "$AVAIL" -lt 20 ]; then
            echo "âŒ Not enough disk space"
            exit 1
          fi

      # ===============================
      # INSTALL TOOLS (MINIMAL)
      # ===============================
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            aria2 p7zip-full unzip \
            erofs-utils e2fsprogs \
            build-essential git \
            libsparse-utils \
            liblz4-tool

          wget -q https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpunpack -O /usr/local/bin/lpunpack
          wget -q https://raw.githubusercontent.com/LineageOS/android_prebuilts_extract-tools/lineage-21.0/linux-x86/bin/lpmake -O /usr/local/bin/lpmake
          chmod +x /usr/local/bin/lp*

          wget -q https://github.com/twrpdtgen/binaries/raw/master/linux/x86/make_ext4fs -O /usr/local/bin/make_ext4fs
          chmod +x /usr/local/bin/make_ext4fs

          wget -q https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          unzip -q Magisk-v27.0.apk -d magisk
          cp magisk/lib/x86_64/libmagiskboot.so /usr/local/bin/magiskboot
          chmod +x /usr/local/bin/magiskboot
          rm -rf magisk Magisk-v27.0.apk

      # ===============================
      # PREPARE WORKSPACE
      # ===============================
      - name: Prepare workspace
        run: |
          mkdir -p workspace/{stock,port,work,final/images,assets}

      # ===============================
      # PROCESS STOCK ROM
      # ===============================
      - name: Process STOCK
        run: |
          set -e
          cd workspace/stock
          aria2c -x4 "${{ inputs.stock_url }}" -o stock.tgz
          tar -xf stock.tgz
          cd $(find . -name images | head -n1)

          simg2img super.img super.raw
          lpunpack super.raw .

          cp boot.img ../../final/images/boot_stock.img
          cp dtbo.img ../../final/images/
          cp vbmeta.img ../../final/images/

          mv vendor*.img ../../work/vendor.img
          mv odm*.img ../../work/odm.img || true
          mv product*.img ../../work/stock_product.img

      # ===============================
      # PROCESS PORT ROM
      # ===============================
      - name: Process PORT
        run: |
          set -e
          cd workspace/port
          aria2c -x4 "${{ inputs.port_url }}" -o port.tgz
          tar -xf port.tgz
          cd $(find . -name images | head -n1)

          simg2img super.img super.raw
          lpunpack super.raw .

          mv system*.img ../../work/system.img
          mv system_ext*.img ../../work/system_ext.img
          mv product*.img ../../work/port_product.img
          mv mi_ext*.img ../../work/mi_ext.img || true

      # ===============================
      # PATCH & REPACK
      # ===============================
      - name: Patch partitions
        run: |
          set -e
          cd workspace/work

          fsck.erofs --extract=pp port_product.img || 7z x port_product.img -opp
          PROP=$(find pp -name build.prop | head -n1)

          ANDROID=$(grep ro.build.version.release $PROP | cut -d= -f2)
          PATCH=$(grep ro.build.version.security_patch $PROP | cut -d= -f2)

          repack() {
            NAME=$1
            IMG=$NAME.img
            [ ! -f "$IMG" ] && return
            rm -rf out
            fsck.erofs --extract=out $IMG || 7z x $IMG -oout
            PROP=$(find out -name build.prop | head -n1)
            [ -f "$PROP" ] && sed -i \
              -e "s/ro.build.version.release=.*/ro.build.version.release=$ANDROID/" \
              -e "s/ro.build.version.security_patch=.*/ro.build.version.security_patch=$PATCH/" \
              "$PROP"
            mkfs.erofs -zlz4hc ../final/images/$IMG out
            rm -rf out
          }

          repack system
          repack system_ext
          repack product
          repack mi_ext
          repack vendor
          repack odm

      # ===============================
      # BUILD SUPER.IMG
      # ===============================
      - name: Build super.img
        run: |
          cd workspace/final/images
          lpmake \
            --metadata-size 65536 \
            --super-name super \
            --device super:9126805504 \
            --group main:9126805504 \
            --partition system:readonly:$(stat -c%s system.img):main \
            --partition system_ext:readonly:$(stat -c%s system_ext.img):main \
            --partition product:readonly:$(stat -c%s product.img):main \
            --partition vendor:readonly:$(stat -c%s vendor.img):main \
            --image system=system.img \
            --image system_ext=system_ext.img \
            --image product=product.img \
            --image vendor=vendor.img \
            --output super.img

      # ===============================
      # PATCH BOOT (ORANGEFOX)
      # ===============================
      - name: Patch boot
        run: |
          cd workspace/final/images
          wget -q https://downloads.sourceforge.net/project/orangefox/alioth/OrangeFox-R11.1_6_A12-Stable-alioth.zip
          unzip -q OrangeFox*.zip recovery.img || true
          [ -f recovery.img ] && mv recovery.img boot.img || mv boot_stock.img boot.img

          magiskboot unpack boot.img
          sed -i 's/$/ androidboot.selinux=permissive/' header
          magiskboot repack boot.img
          mv new-boot.img boot.img

      # ===============================
      # PACKAGE ZIP
      # ===============================
      - name: Pack ZIP
        run: |
          cd workspace/final
          ZIP="${{ inputs.rom_name }}.zip"
          7z a -tzip $ZIP .
          echo "TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Alioth Universal Port
          files: workspace/final/*.zip
          
