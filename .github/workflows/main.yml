name: Port ROM for Poco F3 (Stable Release)

on:
  workflow_dispatch:
    inputs:
      stock_url:
        description: 'Прямая ссылка на STOCK Fastboot ROM (Poco F3)'
        required: true
      port_url:
        description: 'Прямая ссылка на PORT Fastboot ROM (Donor)'
        required: true
      rom_name:
        description: 'Имя для zip архива'
        required: false
        default: 'Alioth_Hybrid_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 python3 git p7zip-full erofs-utils android-sdk-libsparse-utils

      - name: Download Firmwares (Stable Mode)
        run: |
          mkdir -p workspace/stock workspace/port
          cd workspace
          
          # Настройки для более стабильного скачивания с серверов Xiaomi
          # -x4: Меньше потоков (было 16, сервер мог банить)
          # --max-tries=5: 5 попыток скачать, если обрыв
          # --retry-wait=10: ждать 10 секунд перед повтором
          ARIA_ARGS="-x4 -s4 --check-certificate=false --max-tries=5 --retry-wait=10 --continue=true"

          echo "Downloading Stock..."
          aria2c $ARIA_ARGS "${{ inputs.stock_url }}" -d stock -o stock.tgz
          
          echo "Downloading Port..."
          aria2c $ARIA_ARGS "${{ inputs.port_url }}" -d port -o port.tgz
          
          # Проверка размера файлов (не пустые ли они)
          if [ ! -s stock/stock.tgz ] || [ ! -s port/port.tgz ]; then
            echo "ERROR: Download failed (empty file). Check URLs!"
            exit 1
          fi

      - name: Extract Images (7-Zip Method)
        run: |
          cd workspace
          
          echo ">>> Extracting Stock with 7z..."
          cd stock
          # 7z распакует любой архив (zip/tgz), игнорируя ошибки структуры если возможно
          7z x stock.tgz -y
          # Если внутри был еще один tar (часто бывает в tgz)
          if ls *.tar 1> /dev/null 2>&1; then 7z x *.tar -y; fi
          cd ..
          
          echo ">>> Extracting Port with 7z..."
          cd port
          7z x port.tgz -y
          if ls *.tar 1> /dev/null 2>&1; then 7z x *.tar -y; fi
          cd ..

          echo ">>> Finding and moving images..."
          # Эта магия найдет файлы где угодно (в любой подпапке) и вытащит их в корень
          find stock -type f -name "boot.img" -exec mv {} stock/ \;
          find stock -type f -name "vendor.img" -exec mv {} stock/ \;
          find stock -type f -name "product.img" -exec mv {} stock/ \;
          find stock -type f -name "dtbo.img" -exec mv {} stock/ \;
          find stock -type f -name "vbmeta.img" -exec mv {} stock/ \;

          find port -type f -name "system.img" -exec mv {} port/ \;
          find port -type f -name "system_ext.img" -exec mv {} port/ \;
          find port -type f -name "product.img" -exec mv {} port/ \;
          find port -type f -name "mi_ext.img" -exec mv {} port/ \;

          echo ">>> Verifying extracted files..."
          if [ ! -f stock/boot.img ]; then echo "ERROR: boot.img missing in Stock!"; exit 1; fi
          if [ ! -f port/system.img ]; then echo "ERROR: system.img missing in Port!"; exit 1; fi

      - name: Patch Product Partition
        run: |
          cd workspace
          
          # Распаковка EROFS
          extract.erofs -i stock/product.img -x -o stock_product_extracted
          extract.erofs -i port/product.img -x -o port_product_extracted

          # Device Features (Alioth)
          TARGET_DIR="port_product_extracted/etc/device_features"
          SOURCE_FILE="stock_product_extracted/etc/device_features/alioth.xml"
          
          if [ -f "$SOURCE_FILE" ]; then
             mkdir -p "$TARGET_DIR"
             cp "$SOURCE_FILE" "$TARGET_DIR/"
             # Удаляем лишние xml, оставляем только alioth
             find "$TARGET_DIR" -type f -name "*.xml" ! -name "alioth.xml" -delete
          else
             echo "WARNING: alioth.xml not found! Skipping copy."
          fi

          # Overlays swap
          OVERLAY_SRC="stock_product_extracted/overlay/AospFrameworkResOverlay.apk"
          OVERLAY_DST="port_product_extracted/overlay/AospFrameworkResOverlay.apk"
          if [ -f "$OVERLAY_SRC" ]; then cp "$OVERLAY_SRC" "$OVERLAY_DST"; fi

          # Build.prop mods
          PROP_FILE="port_product_extracted/build.prop"
          if [ -f "$PROP_FILE" ]; then
            echo >> "$PROP_FILE"
            echo "# Ported via GitHub Actions" >> "$PROP_FILE"
            echo "ro.product.product.name=alioth" >> "$PROP_FILE"
            echo "ro.product.product.device=alioth" >> "$PROP_FILE"
            echo "ro.product.product.model=M2012K11AC" >> "$PROP_FILE"
          fi
          
          # Repack Product
          # Удаляем старый и собираем новый
          rm port/product.img
          mkfs.erofs -zlz4hc,9 -T 1230768000 --mount-point /product port/product.img port_product_extracted

      - name: Pack Final ZIP
        id: pack
        run: |
          cd workspace
          mkdir -p final_rom/images
          
          # Собираем файлы в кучу
          cp port/system.img final_rom/images/
          cp port/system_ext.img final_rom/images/
          [ -f port/mi_ext.img ] && cp port/mi_ext.img final_rom/images/
          cp port/product.img final_rom/images/
          
          cp stock/boot.img final_rom/images/
          cp stock/vendor.img final_rom/images/
          [ -f stock/dtbo.img ] && cp stock/dtbo.img final_rom/images/
          [ -f stock/vbmeta.img ] && cp stock/vbmeta.img final_rom/images/

          # Скрипт прошивки
          cat <<EOF > final_rom/Flash_ROM.bat
          @echo off
          echo Flashing Port ROM...
          fastboot flash boot images/boot.img
          fastboot flash dtbo images/dtbo.img
          fastboot flash vendor images/vendor.img
          fastboot flash system images/system.img
          fastboot flash system_ext images/system_ext.img
          fastboot flash product images/product.img
          if exist images\mi_ext.img fastboot flash mi_ext images/mi_ext.img
          echo Done. Rebooting...
          fastboot reboot
          pause
          EOF
          
          # Создаем ZIP
          cd final_rom
          ZIP_NAME="${{ inputs.rom_name }}.zip"
          # Используем -mx3 для скорости, так как файлы уже сжаты (img)
          7z a -tzip -mx3 "$ZIP_NAME" .
          
          echo "ZIP_PATH=$(pwd)/$ZIP_NAME" >> $GITHUB_ENV
          echo "RELEASE_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Alioth Port ${{ env.RELEASE_TAG }}
          body: |
            Automatic Port for Poco F3
            Base: ${{ inputs.port_url }}
          files: ${{ env.ZIP_PATH }}
